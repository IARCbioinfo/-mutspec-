<tool id="hotspot" name="MutSpec HotSpot" version="0.1" hidden="false">
<description>
Compute variant frequency on a defined dataset
</description>

<requirements>
    <requirement type="set_environment">SCRIPT_PATH</requirement>
    <requirement type="package" version="5.18.1">perl</requirement>
</requirements>


<command>
mkdir in;

#for $f in $dataset_list
ln -s "$f" "in/$f.name";
#end for

sh \$SCRIPT_PATH/hotspotconfig.sh in output outputsummary $infofile $pair


</command>

<inputs>
<param name="dataset_list" type="data_collection" format="tabular" collection_type="list" label="Dataset List" optional="false" help="Select a dataset list/collection from your history" />
<param name="infofile" type="data" optional="true" format="tabular" label="InfoFile containing input file name." help="See the documentation to format it correctly." />
<param type="boolean" name="pair" checked="TRUE" truevalue="Y" falsevalue="N" label="Tumor-Normal(-Replicates) paired analysis? - If yes, you must provide an InfoFile with Normal-Tumor(-Replicates)." help="For additional annotation on germline or somatic variant status (see Figure 3)" />
</inputs>

<outputs>
<data name="variants_summary" label="variants_summary.vcf" from_work_dir="outputsummary/variants_summary.vcf" format="tabular">
<discover_datasets pattern="__name__" directory="outputsummary"/>
</data>
<collection name="annotated_output" type="list" label="Annotated_dataset">
       <discover_datasets pattern="__name__" ext="tabular" directory="output"/>
    </collection>
</outputs>         

<stdio>
<regex match="Err :"
source="both"
level="fatal"
description="Please read the doc" />

<regex match="Program STOP"
source="both"
level="fatal"
description="Please read the doc" />

</stdio>

<help>

====================
**What it does**
====================

HotSpot computes variant frequencies in a defined dataset (see **Figure 1**).

The dataset is defined by a collection of sample-specific lists of variants.
Frequencies can be calculated on the entire collection, as well as by user-defined categories of samples.
Users can define categories using an information file (see examples in the input section below).

=======================================================
Figure 1 - Count variant frequency on a define dataset
=======================================================

.. image:: computefreq.png
	:height: 262
	:width: 562


.. class:: infomark

**Example of HotSpot application on a series where there is one category made of three input variant file (Sample 1,2 and 3)**

--------------------------------------------------------------------------------------------------------------------------------------------------

==========
**Input**
==========
Data :
----------

The tool accepts a **dataset collection of tabular files** in VCF (version 4.1 or 4.2) or in tab-delimited (TAB) format.

.. class:: infomark

TIP: If your data is not TAB delimited, use *Text manipulation -> convert*

.. class:: warningmark

These files should contain at least four columns describing for each variant, the chromosome number, the start genomic position, the reference allele and the alternate allele

.. class:: infomark

You should thus **create a dataset list** even when using one file (see Galaxy help to learn `how to create a dataset list`__)

.. __: https://wiki.galaxyproject.org/Histories#Dataset_Collections

.. class:: warningmark

All input files must **have the same format**.    

.. class:: warningmark 

The tool supports different column names (**names are case-sensitive**) depending on the source file as follows:

**mutect** :     contig position ref_allele alt_allele

**vcf** :        CHROM POS REF ALT

**cosmic** :     Mutation_GRCh37_chromosome_number Mutation_GRCh37_genome_position Description_Ref_Genomic Description_Alt_Genomic

**icgc** :       chromosome chromosome_start reference_genome_allele mutated_to_allele

**tcga** :       Chromosome Start_position Reference_Allele Tumor_Seq_Allele2

**ionTorrent** : chr Position Ref Alt            

**proton** :     Chrom Position Ref Variant        

**varScan2** :   Chrom Position Ref VarAllele

**annovar** :    Chr Start Ref Obs                 

**custom** :     Chromosome Start Wild_Type Mutant

.. class:: infomark

For MuTect and Mutect 2 output files, only confident calls are considered (variants containing the string REJECT in the judgement column are excluded).
                                                
----------
InfoFile :
----------

If using categories, you need to prepare a **tabular file** associating the name of the different input files to sample categories as follows: 


**If using a tumor-normal pair design (with or without tumor replicates)**

Name the first column as Normal, the second column will be Tumor. Fill the columns with appropriate file names. You may include unmatched samples, but in this case use “NA” for missing Normal and Tumor files.

+-------------------+-------------------+-------------------+
|      Normal       |       Tumor       |     Replicates    |
+===================+===================+===================+
|    Sample_1_N     |     Sample_1_T    |   Sample_1_TDup   |
+-------------------+-------------------+-------------------+
|    Sample_2_N     |     Sample_2_T    |                   |
+-------------------+-------------------+-------------------+
|         NA        |     Sample_3_T    |                   |
+-------------------+-------------------+-------------------+

.

.. class:: warningmark

This tabular file **does not support empty field** for Normal and Tumor file, so please name "NA" a missing file.

.. class:: infomark

The files in the column "Replicates" will be considers as "Tumor" file for computing the variant frequency and count.

**If using any type of categories (one or more categories)**

Organize categories of samples by columns. You may use any names for columns (use preferably short names). 

+-------------------+-------------------+-------------------+-------------------+
|    Category_1     |    Category_2     |     Category_3    |    Category_N     |
+===================+===================+===================+===================+
|     Sample_1      |      Sample_2     |      Sample_3     |     Sample_4      |
+-------------------+-------------------+-------------------+-------------------+
|     Sample_5      |                   |      Sample_7     |     Sample_8      |
+-------------------+-------------------+-------------------+-------------------+
|     Sample_9      |                   |                   |                   |
+-------------------+-------------------+-------------------+-------------------+

.

.. class:: infomark

You can name your column as you want. It supports empty field.


-------------
No InfoFile :
-------------

**If you don't provide an InfoFile, you can not make a pair analysis.** (see **Figure 1**)

.. class:: warningmark

Only one category will be consider by the tool to compute the frequency.

----------
Pair :
----------

**If you choose a pair analysis, you must provide an InfoFile.**

.. class:: infomark

The tool will add an annotation on the statut of the variant as describe in Figure 3.

.. class:: warningmark

You must provide an InfoFile that begin with "Normal".

.. class:: warningmark

You can not provide an InfoFile with more than 3 column (Normal - Tumor - Duplicate).


**If you don't choose a pair analysis, you don't need to provide an InfoFile.**

.. class:: infomark

Even if you provide an InfoFile that begin by "Normal", you will not have any annotation other than the variant frequency if input field paired analysis is "No".

--------------------------------------------------------------------------------------------------------------------------------------------------

==========
**Output**
==========

HotSpot tool generates two files : (see **Figure 2**)

**I - Variants_summary.vcf:**

+ This file contains **all unique variants detected in the dataset**, annotated with counts and frequencies in each user-defined category and with sample name in which they were found.



**II - Annotated_dataset:**

+ This output is a collection that contains **all the input files annotated** with variant frequencies and counts in each user-defined category.
+ If working with the case scenario "Normal-Tumor-Duplicates", an additional annotation is included on variant germline or somatic status (see Figure 3).


--------------------------------------------------------------------------------------------------------------------------------------------------


=============================
Figure 2 - HotSpot workflow
=============================

.. image:: hotspot.png
	:height: 412
	:width: 562


.. class:: infomark

**General example of HotSpot application**

--------------------------------------------------------------------------------------------------------------------------------------------------

=========================================================
Figure 3 - Annotation for Normal-Tumor(-Replicate) pairs
=========================================================

.. image:: annotation.png
	:height: 412
	:width: 562


.. class:: infomark

**Example of annotation of variants in the case "Normal-Tumor-Replicates"**

.. class:: infomark

**For a variant annotated as Somatic, if it's find in the Tumor twice (Replicates also), it will be annotated as Somatic **confirmed** if there is a normal sample for this individual and the variant was not found.**

.. class:: infomark

**For a variant annotated as Somatic, if it's find in the Tumor once (Tumor or Replicate), it will be annotated as Somatic **not confirmed** if there is a normal sample for this individual and the variant was not found.**

.. class:: infomark

**For a variant annotated as Somatic, if it's find in the Tumor once (Tumor or Replicate) or twice (Tumor and Replicate), it will be annotated as Somatic **NA** if there is **no** a normal sample for this individual**


--------------------------------------------------------------------------------------------------------------------------------------------------

**Contact**

robitaillea@students.iarc.fr; ardinm@fellows.iarc.fr; cahaisv@iarc.fr

--------------------------------------------------------------------------------------------------------------------------------------------------

**Code**

The source code is available on `GitHub`__

.. __: https://github.com/IARCbioinfo/mutspec.git

</help>
</tool>